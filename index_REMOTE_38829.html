<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="同文館">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="同文館">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="同文館">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> 同文館 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-tw">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-90094724-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?74871b5422f5ef687b8d125ec7cc3a14";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">同文館</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            關於
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            標籤
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/03/26/reborn/" itemprop="url">
                  找回旧时玩代码的感觉
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2021-03-26T20:45:00+08:00" content="2021-03-26">
              2021-03-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="找回旧时玩代码的感觉"><a href="#找回旧时玩代码的感觉" class="headerlink" title="找回旧时玩代码的感觉"></a>找回旧时玩代码的感觉</h1><p>上一次提交的博客还在2017年，虽然这几年间偶尔会做一些自己感兴趣的side project，但是基本上没有话费太多时间精力在这些项目上。其中一个应用在 Google play 上架一段时间，半年时间盈利200美金，还有一个用户通过我的反馈邮箱找到了我的PayPle账号，很意外的收到了5美元的PayPle捐款，后面服务器厂商跑路了，碍于某些不可抗因素，再三考虑还是放弃了这个这个项目，我自己把APP在商店下了架。于此同时谷歌商店政策在不断变化，更早之前的一些应用也放弃了维护，现在我的Google Play账号下都是空的。</p>
<p>这数年间见证了公司项目从零到千万月活的每一个脚步，工作开发任务多，这些任务基本上占据了我大部分的精力。农历一直思考，回顾过去，我发现我缺少某些东西，之前为止心里向往的被其他东西给代替了。其中最让我感到失落的是我好像失去了寻找创作力的热情。看了不同的书，看了不同的电影，听了不同的音乐，看了不同的代码，发现好东西当然会相当愉悦，会去羡慕那些作者的创作力，我也想那样，也仅仅只是想而已。</p>
<p>今天周五啊，下班回来先把自己的给敲碎，在这一篇Blog开始，开始追寻我的创作激情和创作力。</p>
<p>先立个Flag，把过去看的书做一些回顾了整理，重新输出一些Blog，还有开始我下一个Side Project。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/17/scala_android_sby2/" itemprop="url">
                  Scala 语言开发Andorid ，开发环境的搭建(二)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2017-01-17T13:12:00+08:00" content="2017-01-17">
              2017-01-17
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Scala-语言开发Andorid-，开发环境的搭建-二"><a href="#Scala-语言开发Andorid-，开发环境的搭建-二" class="headerlink" title="Scala 语言开发Andorid ，开发环境的搭建(二)"></a>Scala 语言开发Andorid ，开发环境的搭建(二)</h1><h2 id="什么是-sbt-？"><a href="#什么是-sbt-？" class="headerlink" title="什么是 sbt ？"></a>什么是 sbt ？</h2><p>上一篇文章介绍过，sbt 就是和 maven ，ant 类似的自动构建工具。<br>那 sbt 有什么优势呢？</p>
<ol>
<li>相对其他构建工具更快的编译速度，只编译修改过的文件以及引用的第三方库依赖</li>
<li>triggered execution 特性方便做测试驱动的开发</li>
<li>依据类和依赖使用 Scala 的解析器</li>
<li>sbt 是基于 Scala ，所以可以灵活的使用 Scala 构建工程</li>
<li>支持 java 和 Scala 的混合编程</li>
</ol>
<h2 id="基本目录"><a href="#基本目录" class="headerlink" title="基本目录"></a>基本目录</h2><p>工程的根目录下的文件和文件夹，下面看看文件夹里面到底是什么东西。</p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p>根下的 src 目录就是存放源码文件的地方呢<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">src/</div><div class="line">  main/</div><div class="line">    resources/</div><div class="line">       &lt;files to <span class="keyword">include</span> <span class="keyword">in</span> main jar here&gt;</div><div class="line">    <span class="keyword">scala</span>/</div><div class="line">       &lt;main <span class="keyword">Scala</span> sources&gt;</div><div class="line">    java/</div><div class="line">       &lt;main Java sources&gt;</div><div class="line">  <span class="keyword">test</span>/</div><div class="line">    resources</div><div class="line">       &lt;files to <span class="keyword">include</span> <span class="keyword">in</span> <span class="keyword">test</span> jar here&gt;</div><div class="line">    <span class="keyword">scala</span>/</div><div class="line">       &lt;<span class="keyword">test</span> <span class="keyword">Scala</span> sources&gt;</div><div class="line">    java/</div><div class="line">       &lt;<span class="keyword">test</span> Java sources&gt;</div></pre></td></tr></table></figure></p>
<h3 id="sbt-配置文件"><a href="#sbt-配置文件" class="headerlink" title="sbt 配置文件"></a>sbt 配置文件</h3><p>在一个小项目中一两个 sbt 文件已经足够了，当时随着项目的扩展有可能要同时管理多个 sbt 文件</p>
<p>一般情况下我们习惯使用 build.sbt 作为文件的名称，当然你也可以使用任何的名字。</p>
<p>根目录下的 sbt 文件<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">build<span class="selector-class">.sbt</span></div><div class="line">project/</div><div class="line">  plugin<span class="selector-class">.sbt</span></div><div class="line">  Build<span class="selector-class">.scala</span></div><div class="line">  &lt;Other Scala files&gt;</div></pre></td></tr></table></figure></p>
<p>看到这里你可能会还好奇，sbt 和 Scala  的配置文件有什么区别</p>
<p>一般推荐，sbt 文件作为项目的主要设定文件，而 scala 用于设置第三方依赖或者版本信息等</p>
<h2 id="编写build-sbt"><a href="#编写build-sbt" class="headerlink" title="编写build.sbt"></a>编写build.sbt</h2><p>下面一步一步写出项目到build.sbt 文件</p>
<h3 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h3><p>在我们的定义文件了，我们只需要关注设置的表达式 </p>
<p>下面的实例显示了项目版本号命名等基本信息，还有 项目中使用的 Scala 版本的配置信息<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">name := <span class="string">"scala-on-android"</span></div><div class="line"></div><div class="line">organization := <span class="string">"com.fortysevendeg"</span></div><div class="line"></div><div class="line">organizationName := <span class="string">"47 Degrees"</span></div><div class="line"></div><div class="line">organizationHomepage := Some(<span class="built_in">new</span> URL(<span class="string">"http://47deg.com"</span>))</div><div class="line"></div><div class="line">version := <span class="number">0.1</span><span class="number">.0</span></div><div class="line"></div><div class="line">scalaVersion := <span class="number">2.11</span><span class="number">.6</span></div></pre></td></tr></table></figure></p>
<p>不难发现上面的例子 使用 := 作为连接符</p>
<p>另外还可以使用其他的连接符<br>+= 添加多一个元素<br>++= 添加多个元素<br>例如</p>
<blockquote>
<p>scalacOptions ++= Seq(“-feature”, “-deprecation”)</p>
</blockquote>
<h3 id="添加第三方库依赖"><a href="#添加第三方库依赖" class="headerlink" title="添加第三方库依赖"></a>添加第三方库依赖</h3><p>和 gradle 一样，其实库的添加分两种<br>一是添加本地 jar 包<br>二是添加远程仓库库</p>
<h4 id="添加-jar-包"><a href="#添加-jar-包" class="headerlink" title="添加 jar 包"></a>添加 jar 包</h4><p>使用 jar 包最简单到方式是直接把 jar 放到下面目录，这样项目就会自动导入 jar 包</p>
<blockquote>
<p>/src/main/libs</p>
</blockquote>
<p>除此之外还能使用自定义到路径</p>
<blockquote>
<p>unmanagedBase := baseDirectory.value / “custom_lib”</p>
</blockquote>
<h4 id="远程依赖"><a href="#远程依赖" class="headerlink" title="远程依赖"></a>远程依赖</h4><p>远程依赖使用是 ivy 到远程管理仓库，同样你可以使用 += 或者 ++= 到导入一个或多个依赖<br>先看看导入一个到基本表达式</p>
<blockquote>
<p>libraryDependencies += groupID % artifactID % revision [% configuration]</p>
</blockquote>
<p>导入多个<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">libraryDependencies ++= Seq(</div><div class="line">  <span class="name">aar</span>(<span class="string">"com.android.support"</span> %  <span class="string">"cardview-v7"</span> % <span class="string">"22.0.0"</span>),</div><div class="line">  aar(<span class="string">"com.android.support"</span> % <span class="string">"appcompat-v7"</span> % <span class="string">"22.0.0"</span>),</div><div class="line">  aar(<span class="string">"com.android.support"</span> % <span class="string">"recyclerview-v7"</span> % <span class="string">"22.0.0"</span>),</div><div class="line">  aar(<span class="string">"com.google.android.gms"</span> % <span class="string">"play-services-base"</span> % <span class="string">"6.5.87"</span>),</div><div class="line">  <span class="string">"com.typesafe.play"</span> %% <span class="string">"play-json"</span> % <span class="string">"2.3.6"</span>,</div><div class="line">  <span class="string">"org.specs2"</span> %% <span class="string">"specs2-core"</span> % <span class="string">"2.4.15"</span> % <span class="string">"test"</span>,</div><div class="line">  <span class="string">"org.specs2"</span> % <span class="string">"specs2-mock_2.11"</span> %  <span class="string">"3.0-M2"</span> % <span class="string">"test"</span>)</div></pre></td></tr></table></figure></p>
<p>上面可见，可以使用 % 作为分割符，那 %% 又代表上面意思呢。其实为何配合不同版本的 scala ，需要不同依赖， %% 就是解决这个问题的，例如上面的 “org.specs2” %% “specs2-core”  sbt 构建工具就根据不同情况选择合适的 org.specs2 或者 specs2-core 库。</p>
<h3 id="添加-sbt-插件"><a href="#添加-sbt-插件" class="headerlink" title="添加 sbt 插件"></a>添加 sbt 插件</h3><p> 在目录 project 下有一个 plugin.sbt 文件，只需要 配置相关的信息就能方便安装对应的插件。为了更加方便使用 sbt 管理我们的 Android 工程，可以使用一些插件让开发过程中更加方便，这里说一个常用的插件<br>  <a href="https://github.com/scala-android/sbt-android" target="_blank" rel="external">sbt-android</a>,详细使用和配置的可以看开发文档。这里只演示如何最快的安装。只需要在 plugin.sbt 添加一行便可以完成安装</p>
<blockquote>
<p>addSbtPlugin(“org.scala-android” % “sbt-android” % “1.7.1”)</p>
</blockquote>
<p> 接着在 根目录下的 build.sbt 中使用我们的插件</p>
<blockquote>
<p>android.Plugin.androidBuild<br> platformTarget in Android := “android-21”</p>
</blockquote>
<p> 这样遍可以使用这个插件提供的一些功能，例如 compile（编译），android:run（运行），android:package-release（打包）等操作。</p>
<p>此外插件还提供了打包的配置方案如下面设置签名文件的路径等信息<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">packageRelease &lt;&lt;= (packageRelease <span class="keyword">in</span> Android).dependsOn(setDebugTask(<span class="literal">false</span>))</div><div class="line"></div><div class="line">apkSigningConfig <span class="keyword">in</span> Android := <span class="keyword">Option</span>(</div><div class="line">  PromptPasswordsSigningConfig(</div><div class="line">    keystore = <span class="keyword">new</span> File(Path.userHome.absolutePath + <span class="string">"/.android/signed.keystore"</span>),</div><div class="line">    <span class="keyword">alias</span> = <span class="string">"my-password"</span>))</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/10/scala_android_sby/" itemprop="url">
                  Scala 语言开发Andorid ，开发环境的搭建(一)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2017-01-10T21:43:00+08:00" content="2017-01-10">
              2017-01-10
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Scala-语言开发Andorid-，开发环境的搭建-一"><a href="#Scala-语言开发Andorid-，开发环境的搭建-一" class="headerlink" title="Scala 语言开发Andorid ，开发环境的搭建(一)"></a>Scala 语言开发Andorid ，开发环境的搭建(一)</h1><p>厌倦 Java 繁琐的语法，为了更优雅的开发 Android 程序，Scala 代替 Java 是一个不错的尝试。 开发前可以学习 Scala 的基本语法，某些部分和 Java 非常类似，但又聚合了其他先进语言的特性。与 Java 不同的是，在你熟悉函数式编程的情况下能写出更加优雅的代码。</p>
<h2 id="SBT-构建工具"><a href="#SBT-构建工具" class="headerlink" title="SBT 构建工具"></a>SBT 构建工具</h2><p>现在绝大多数的 Android 开发者是官方提供的 Android Studio ，这个 IDE 使用的是基于 Gradle 的自动化建构工具，通过 Gradle 可以配置 Project 各种参数，生产 APK 等操作。<br>SBT 是和 Gradle,Ant,Maven 一样的自动化建构工具，SBT 方便管理我们用 Scala 编写的 Android 工程。</p>
<p>和使用 Java 开发 Andoird 一样，首先要安装 Scala， <a href="http://scala-lang.org/download/" target="_blank" rel="external">下载</a> 官方文件，在此之前先确定电脑已经安装配置好 Java 环境。如果 macOS 已经安装有 Homebrew 只需要一行代码即可安装配置成功<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span><span class="keyword">install </span><span class="keyword">scala</span></div></pre></td></tr></table></figure></p>
<p>接着安装 SBT 同一也一行代码搞定(赶紧换一台 mac 吧~~<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">brew </span><span class="keyword">install </span><span class="keyword">sbt</span></div></pre></td></tr></table></figure></p>
<p>其他系统的配置大可直接看 <a href="(http://scala-lang.org/">Scala</a> 和 <a href="http://www.scala-sbt.org/index.html" target="_blank" rel="external">SBT</a> 官网，里边有详细的安装配置教程</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p>和使用 构建工具一样，Gradle 有一种固定的文件分类方式，不同的文件夹安放不同类型的文件。同样的，SBT 也是有固定的文件结构。其实 SBT 的结构和 Gradle 的结构类似。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">scala-android/</div><div class="line">|<span class="string">- project/</span></div><div class="line">|<span class="string">  </span>|<span class="string">- plugins.sbt </span></div><div class="line">|<span class="string">- src/</span></div><div class="line">|<span class="string">  </span>|<span class="string">- main/</span></div><div class="line">|<span class="string">     </span>|<span class="string">- assets/</span></div><div class="line">|<span class="string">     </span>|<span class="string">- java/</span></div><div class="line">|<span class="string">     </span>|<span class="string">- res/</span></div><div class="line">|<span class="string">        </span>|<span class="string">- layout/</span></div><div class="line">|<span class="string">           </span>|<span class="string">- main.xml</span></div><div class="line">|<span class="string">        </span>|<span class="string">- values/</span></div><div class="line">|<span class="string">           </span>|<span class="string">- strings.xml</span></div><div class="line">|<span class="string">     </span>|<span class="string">- scala/</span></div><div class="line">|<span class="string">        </span>|<span class="string">- com/</span></div><div class="line">|<span class="string">           </span>|<span class="string">- fortysevendeg/</span></div><div class="line">|<span class="string">              </span>|<span class="string">- scala/</span></div><div class="line">|<span class="string">                 </span>|<span class="string">- android/</span></div><div class="line">|<span class="string">                    </span>|<span class="string">- SampleActivity.scala/</span></div><div class="line">|<span class="string">     </span>|<span class="string">- AndroidManifest.xml</span></div><div class="line">|<span class="string">  </span>|<span class="string">- test/</span></div><div class="line">|<span class="string">     </span>|<span class="string">- java/</span></div><div class="line">|<span class="string">     </span>|<span class="string">- res/</span></div><div class="line">|<span class="string">     </span>|<span class="string">- scala/</span></div><div class="line">|<span class="string">- build.sbt</span></div></pre></td></tr></table></figure>
<h2 id="结构文件"><a href="#结构文件" class="headerlink" title="结构文件"></a>结构文件</h2><p>根目录下，src 文件夹内存放的有源码的文件，布局文件，以及另外一些资源文件。java 文件存放的是 java的源代码文件，scala文件夹里存放的当然是 scala 源代码文件，和 java 编写的结构一样，倒序域名包命名的管理方式。text存放的是测试文件。</p>
<p>build.sbt 和 app 中Gradle build  文件类似，可以配置一些项目信息，例如管理包名，应用名，编译的目标版本，最低限制版本，开启混淆的。使用的语法与 gradle 的语法略有不同。下面是一些常用的配置信息。<br><strong>build.sbt</strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 申明使用 Android 插件，让构造工具知道这是一个Android 工程</span></div><div class="line">android.Plugin.androidBuild</div><div class="line">​    </div><div class="line"><span class="comment">// 生命 Android 目标 API </span></div><div class="line">platformTarget <span class="keyword">in</span> <span class="string">Android :</span>= <span class="string">"android-21"</span></div><div class="line"></div><div class="line"><span class="comment">// 应用名</span></div><div class="line"><span class="string">name :</span>= <span class="string">"""scala-android"""</span></div><div class="line"></div><div class="line"><span class="comment">// 应用版本号</span></div><div class="line"><span class="string">version :</span>= <span class="string">"1.0.0"</span></div><div class="line"></div><div class="line"><span class="comment">// Scala 版本</span></div><div class="line"><span class="string">scalaVersion :</span>= <span class="string">"2.11.4"</span></div><div class="line"></div><div class="line"><span class="comment">// 项目中依赖的库</span></div><div class="line">resolvers += Resolver.jcenterRepo</div><div class="line">libraryDependencies ++=</div><div class="line">  <span class="string">"com.android.support"</span> % <span class="string">"cardview-v7"</span> % <span class="string">supportLibsVersion :</span>:</div><div class="line">  <span class="string">"com.android.support"</span> % <span class="string">"customtabs"</span> % <span class="string">supportLibsVersion :</span>:</div><div class="line">  <span class="string">"com.android.support"</span> % <span class="string">"design"</span> % <span class="string">supportLibsVersion :</span>:</div><div class="line">  <span class="string">"com.android.support"</span> % <span class="string">"gridlayout-v7"</span> % <span class="string">supportLibsVersion :</span>:</div><div class="line">  <span class="string">"com.android.support"</span> % <span class="string">"preference-v14"</span> % <span class="string">supportLibsVersion :</span>:</div><div class="line">  <span class="string">"com.futuremind.recyclerfastscroll"</span> % <span class="string">"fastscroll"</span> % <span class="string">"0.2.5"</span> ::</div><div class="line">  <span class="string">"com.evernote"</span> % <span class="string">"android-job"</span> % <span class="string">"1.1.4"</span> ::</div><div class="line">  <span class="string">"com.github.jorgecastilloprz"</span> % <span class="string">"fabprogresscircle"</span> % <span class="string">"1.01"</span> ::</div><div class="line">  <span class="string">"com.google.android.gms"</span> % <span class="string">"play-services-ads"</span> % <span class="string">playServicesVersion :</span>:</div><div class="line">  <span class="string">"com.google.android.gms"</span> % <span class="string">"play-services-analytics"</span> % <span class="string">playServicesVersion :</span>:</div><div class="line">  <span class="string">"com.google.android.gms"</span> % <span class="string">"play-services-gcm"</span> % <span class="string">playServicesVersion :</span>:</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 开启 Scala 混淆</span></div><div class="line">proguardScala <span class="keyword">in</span> <span class="string">Android :</span>= <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">// 开启 Android 混淆</span></div><div class="line">useProguard <span class="keyword">in</span> <span class="string">Android :</span>= <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">// 设置混淆规则</span></div><div class="line">proguardOptions <span class="keyword">in</span> Android ++= Seq(</div><div class="line">  <span class="string">"-ignorewarnings"</span>,</div><div class="line">  <span class="string">"-keep class scala.Dynamic"</span>)</div></pre></td></tr></table></figure></p>
<p>project/plugins.sbt文件是项目中构建工具使用到的插件<br><strong>project/plugins.sbt</strong><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">addSbtPlugin</span><span class="params">(<span class="string">"org.scala-android"</span> % <span class="string">"sbt-android"</span> % <span class="string">"1.7.2"</span>)</span></span></div><div class="line"><span class="function"><span class="title">addSbtPlugin</span><span class="params">(<span class="string">"com.timushev.sbt"</span> % <span class="string">"sbt-updates"</span> % <span class="string">"0.1.10"</span>)</span></span></div><div class="line"><span class="function"><span class="title">addSbtPlugin</span><span class="params">(<span class="string">"net.virtual-void"</span> % <span class="string">"sbt-dependency-graph"</span> % <span class="string">"0.8.2"</span>)</span></span></div></pre></td></tr></table></figure></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/21/badstory2/" itemprop="url">
                  爛的故事（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-12-21T17:35:57+08:00" content="2016-12-21">
              2016-12-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="爛的故事（二）"><a href="#爛的故事（二）" class="headerlink" title="爛的故事（二）"></a>爛的故事（二）</h1><p>寒冷的平安夜下著雪，路上的行人匆匆而過。街角的小女孩還沒賣出一盒火柴。一次次冷漠的拒絕意味著她今晚不會有任何收入。心灰意冷的小女孩划動了一根火柴，燃燒的火柴讓她感到十分溫暖。接著又用凍僵的小手點燃了另一根火柴，這樣一根接著一根。她拿著最後一根火柴，火焰慢慢地慢慢地變得微弱直至熄滅。心滿意足的小女孩才上了她僕人開來的車，開開心心的回家吃聖誕大餐。</p>
<p>劇終</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/28/imageviwe_note/" itemprop="url">
                  ImageView的使用笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-11-28T11:20:00+08:00" content="2016-11-28">
              2016-11-28
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、使用ImageView-的src-和background"><a href="#一、使用ImageView-的src-和background" class="headerlink" title="一、使用ImageView 的src 和background"></a>一、使用ImageView 的src 和background</h3><blockquote>
<p>src ：原图大小，不被拉伸;<br>background：为Imageview的背景，根据ImageView给长宽进行拉伸；</p>
</blockquote>
<h3 id="二、设置Imageview的透明度"><a href="#二、设置Imageview的透明度" class="headerlink" title="二、设置Imageview的透明度"></a>二、设置Imageview的透明度</h3><blockquote>
<p>android:src在设置ImageView的setAlpha(int alpha)时，起作用;<br>android:background在设置ImageView的setAlpha(int alpha)时，不起作用;</p>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mImageView<span class="selector-class">.setBackgroundDrawable</span>(mDrawable.mutate());</div><div class="line">mImageView<span class="selector-class">.getBackground</span>()<span class="selector-class">.setAlpha</span>(<span class="number">100</span>);</div></pre></td></tr></table></figure>
<h3 id="三、设置ImageView的前景（foreground）"><a href="#三、设置ImageView的前景（foreground）" class="headerlink" title="三、设置ImageView的前景（foreground）"></a>三、设置ImageView的前景（foreground）</h3><p>有时候设计需要在ImageView 上面覆盖一层（如灰色）</p>
<blockquote>
<p>View 提供了一个setForeground(Drawable foreground)</p>
</blockquote>
<h3 id="四、使用ImageView的“android-adjustViewBounds”"><a href="#四、使用ImageView的“android-adjustViewBounds”" class="headerlink" title="四、使用ImageView的“android:adjustViewBounds”"></a>四、使用ImageView的“android:adjustViewBounds”</h3><p><strong>如果想设置图片固定大小，又想保持图片宽高比，需要如下设置：</strong></p>
<ol>
<li>设置setAdjustViewBounds为true；</li>
<li>设置maxWidth、MaxHeight；</li>
<li>设置设置layout_width和layout_height为wrap_content</li>
</ol>
<h3 id="五、正确使用ImageView的“android-scaleType”"><a href="#五、正确使用ImageView的“android-scaleType”" class="headerlink" title="五、正确使用ImageView的“android:scaleType”"></a>五、正确使用ImageView的“android:scaleType”</h3><p>ImageView的“android:scaleType”属性是对src才有效的</p>
<p>ScaleDrawable类是afc框架中提供了一个专门处理Drawable scale的类，在ImageView的ScaleType的基础上额外提供了11中裁剪方式：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">（<span class="number">1</span>）CROP_CENTER</div><div class="line">（<span class="number">2</span>）CROP_START</div><div class="line">（<span class="number">3</span>）CROP_END</div><div class="line">（<span class="number">4</span>）FIT_CENTER</div><div class="line">（<span class="number">5</span>）FIT_START</div><div class="line">（<span class="number">6</span>）FIT_END</div><div class="line">（<span class="number">7</span>）MATCH_WIDTH_TOP</div><div class="line">（<span class="number">8</span>）MATCH_WIDTH_BOTTOM</div><div class="line">（<span class="number">9</span>）MATCH_WIDTH_CENTER</div><div class="line">（<span class="number">10</span>）CENTER</div><div class="line">（<span class="number">11</span>）CROP_BY_PIVOT</div></pre></td></tr></table></figure></p>
<p><img src="https://images.thoughtbot.com/blog-vellum-image-uploads/wDbiaqGSQyyErtXGSh6w_scaletype.png" alt="image"></p>
<blockquote>
<p>要保证ScaleDrawable.CROP_START属性设置成功，在xml中一定要设置“android:scaleType=”fitXY”</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/22/memory_leak/" itemprop="url">
                  Android 内存泄露的几中场景
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-11-22T13:57:00+08:00" content="2016-11-22">
              2016-11-22
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Android-内存泄漏"><a href="#Android-内存泄漏" class="headerlink" title="Android 内存泄漏"></a>Android 内存泄漏</h1><p>java 存在一个垃圾回收机制，发生泄漏的原因就是应该被回收的垃圾没有被回收，这种情况就叫做内存泄漏</p>
<p>解决内存泄漏的方法的思路：让不易回收的内存可以在不需要继续使用单情况下被系统回收掉。</p>
<p>怎么做在能让某些内存可以被及时回收呢？这里就需要了解 java 的一个知识点，这就是引用类型。java 分 <a href="https://segmentfault.com/a/1190000003910496" target="_blank" rel="external">四 种引用类型</a>，分别是：强引用，软引用，弱引用，虚引用。这从这四种引用点名称可以推测，系统对于不用类型引用有不同的回收机制。为方便对比列出下方的表格</p>
<table>
<thead>
<tr>
<th>引用类型</th>
<th>回收条件</th>
<th>发生泄漏可能性</th>
</tr>
</thead>
<tbody>
<tr>
<td>强引用</td>
<td>不回收</td>
<td>可能</td>
</tr>
<tr>
<td>软引用</td>
<td>内存不足时回收</td>
<td>不可能</td>
</tr>
<tr>
<td>弱引用</td>
<td>一定回收</td>
<td>不可能</td>
</tr>
<tr>
<td>虚引用</td>
<td>不回收</td>
<td>可能</td>
</tr>
</tbody>
</table>
<p>合理点使用不同的引用类型，可以避免出现内存泄露的情况</p>
<p>在Android开发中，出现内存泄露我认为可以分为两大部分，一部分是 java 相关的，另一部分是 Android Api使用容易出现内存泄露</p>
<p>常见有以下场景</p>
<h5 id="1-单例模式"><a href="#1-单例模式" class="headerlink" title="1. 单例模式"></a>1. 单例模式</h5><p>单例模式生成的静态对象因为生命周期和应用的进程一致，一般只有当应用退出或者运行的进程被结束，对象才能结束对象的生命周。例如当一个单例对象引用一个 activity 变量，即便 activity 可能已经退出了，但是因为单例对象还持有 activity ，所以系统不能回收这个 activity 造成了内存泄露</p>
<blockquote>
<p><em>解决方案</em><br>使用弱应用，例如<br>private WeakReference<activity> wr = null;<br>wr = new WeakReference<activity>(myActivity);</activity></activity></p>
</blockquote>
<h5 id="2-匿名内部类使用-Threads-TimerTasks"><a href="#2-匿名内部类使用-Threads-TimerTasks" class="headerlink" title="2. 匿名内部类使用(Threads , TimerTasks)"></a>2. 匿名内部类使用(Threads , TimerTasks)</h5><p>非静态内部类，匿名类阅读，可以轻易访问外围类的变量，也就是说匿名内部类可以持有外部类的的变量，当外部类的变量可以被回收的时候，当时因为内部类持有外部类的引用，这样就造成了内存泄露。但是静态内部类就不会引用外部变量</p>
<blockquote>
<p><em>解决方案</em><br>1.使用静态内部类<br>2.用弱引用就是引用到的变量<br>3.可以的话，在结束外部类时及时关闭匿名内部类(Thread)</p>
</blockquote>
<h5 id="3-context-的使用"><a href="#3-context-的使用" class="headerlink" title="3. context 的使用"></a>3. context 的使用</h5><p>Context 是 Android 开发中经常传递的变量，但是某些情况下本该被回收的 Context 却因为某些对象依然持有 Context 的引用，进而发生内存泄露</p>
<blockquote>
<p><em>解决方案</em><br>1.使用 ApplicationContext 代替 Context ，因为 ApplicationContext 的生命周期和应用(进程)一样长。<br>2.对于 Context 变量慎用 Static 修饰，</p>
</blockquote>
<h5 id="4-handler-的使用"><a href="#4-handler-的使用" class="headerlink" title="4. handler 的使用"></a>4. handler 的使用</h5><p>Handler 用于延时的一个作用，熟悉 Handler 机制的都应该清楚，我们会把一下需要的一些操作放在 Messagequeue 里面，等待 用户的 handler 对象按队列顺序发送消息。</p>
<p>会存在这样一个场景，当一个 Activity 需要销毁，但是 MessageQueue 还存在一些消息为处理，消息持有 Handler 引用，Handler 持有外部类的引用，这时 Activity 就无法正常回收了。这种情况和非静态内部类引起的原因差不多。</p>
<blockquote>
<p><em>解决方案</em><br>1.把 Handler 实现做一个独立的类或者使用静态修饰<br>2.在 Handler 内部调用到 acivity 等外部变量是可以用弱引用修饰作为 activity 引用类型</p>
</blockquote>
<h5 id="5-Cursor-Bitmap-Stream-没及时释放"><a href="#5-Cursor-Bitmap-Stream-没及时释放" class="headerlink" title="5. Cursor Bitmap Stream 没及时释放"></a>5. Cursor Bitmap Stream 没及时释放</h5><p>打开资源文件，会把文件缓存在内存和 jvm 虚拟机中，在使用结束后如果没有 close() 则会发生内存泄露。</p>
<blockquote>
<p><em>解决方案</em><br>1.使用结束后及时调用 close()</p>
</blockquote>
<h5 id="6-监听器的没及时注销-Sensor-Manager"><a href="#6-监听器的没及时注销-Sensor-Manager" class="headerlink" title="6. 监听器的没及时注销(Sensor Manager)"></a>6. 监听器的没及时注销(Sensor Manager)</h5><p>Android 系统提供了一些服务，要获取这些服务的对象都要使用到 Context 这个变量<br>当一个 activity 关闭后，这些系统级别的服务都会继续持有 Context 引用</p>
<blockquote>
<p><em>解决方案</em><br>1.在退出 Activity 后及时注销监听器<br>2.使用 ApplicationContext 代替 Context </p>
</blockquote>
<h5 id="7-listView-的-adpater-没使用-ConvertView-缓存"><a href="#7-listView-的-adpater-没使用-ConvertView-缓存" class="headerlink" title="7. listView 的 adpater 没使用 ConvertView 缓存"></a>7. listView 的 adpater 没使用 ConvertView 缓存</h5><p>ListView 会缓存一部分 View ，没用使用 getview() 里面的参数 ConvertView</p>
<h5 id="8-静态集合对象没有清理"><a href="#8-静态集合对象没有清理" class="headerlink" title="8. 静态集合对象没有清理"></a>8. 静态集合对象没有清理</h5><p>静态集合里数据多，生命周期与应用一样长，但是依然占据了一部分内存，不需要时没有进行清理的动作</p>
<blockquote>
<p><em>解决方案</em><br>1.退出后 clear 掉集合里面的所有数据，然后赋值 null</p>
</blockquote>
<h5 id="9-webview-没有及时释放"><a href="#9-webview-没有及时释放" class="headerlink" title="9. webview 没有及时释放"></a>9. webview 没有及时释放</h5><p>webview 使用完毕后一样需要 destroy 掉，否者一直常驻内存</p>
<blockquote>
<p><em>解决方案</em><br>因为 webView 耗费大量内存，可以为 WebView 分配一个独立的线程，也主线程做通讯。不需要时也要记得销毁掉。</p>
</blockquote>
<h5 id="10-监听器"><a href="#10-监听器" class="headerlink" title="10.监听器"></a>10.监听器</h5><p>使用监听者模式，我们会添加一些监听器，但是移除被监听对象时，往往忘记取消设置的监听器</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/21/flask_note/" itemprop="url">
                  Flask Web开发笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-11-21T16:09:00+08:00" content="2016-11-21">
              2016-11-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#Flask笔记</p>
<h5 id="2-1初始化"><a href="#2-1初始化" class="headerlink" title="2.1初始化"></a>2.1初始化</h5><p>Web 服务器使用一种名为 Web 服务器网关接口<br>（Web Server Gateway Interface，WSGI）的协议，把接收自客户端的所有请求都转交给这个对象处理。程序实例是 Flask 类的对象</p>
<h5 id="2-2-路由和视图函数"><a href="#2-2-路由和视图函数" class="headerlink" title="2.2 路由和视图函数"></a>2.2 路由和视图函数</h5><p>程序实例需要知道对每个 URL 请求运行哪些代码，所以保存了一个URL到<br>Python 函数的映射关系。处理 URL 和函数之间关系的程序称为路由。</p>
<p><em>在 Python 代码中嵌入响应字符串会导致代码难以维护</em></p>
<h5 id="2-3启动服务器"><a href="#2-3启动服务器" class="headerlink" title="2.3启动服务器"></a>2.3启动服务器</h5><p><strong>name</strong>==’<strong>main</strong>‘ 是 Python 的惯常用法，在这里确保直接执行这个脚本时才启动开发Web 服务器。如果这个脚本由其他脚本引入，程序假定父级脚本会启动不同的服务器，因此不会执行 app.run()。</p>
<p>服务器启动后，会进入轮询，等待并处理请求。轮询会一直运行，直到程序停止，比如按Ctrl-C 键。</p>
<h5 id="2-5请求-响应循环"><a href="#2-5请求-响应循环" class="headerlink" title="2.5请求-响应循环"></a>2.5请求-响应循环</h5><p>######2.5.1　程序和请求上下文</p>
<p>Flask 使用上下文临时把某些对象<br>变为全局可访问。</p>
<table>
<thead>
<tr>
<th>变量名</th>
<th style="text-align:center">上下文</th>
<th style="text-align:right">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>current_app</td>
<td style="text-align:center">程序上下文</td>
<td style="text-align:right">当前激活程序的程序实例</td>
</tr>
<tr>
<td>g</td>
<td style="text-align:center">程序上下文</td>
<td style="text-align:right">处理请求时用作临时存储的对象。每次请求都会重设这个变量</td>
</tr>
<tr>
<td>request</td>
<td style="text-align:center">请求上下文</td>
<td style="text-align:right">请求对象，封装了客户端发出的</td>
</tr>
<tr>
<td>session</td>
<td style="text-align:center">请求上下文</td>
<td style="text-align:right">用户会话，用于存储请求之间需要“记住”的值的词典</td>
</tr>
</tbody>
</table>
<h5 id="2-5-2-请求调度"><a href="#2-5-2-请求调度" class="headerlink" title="2.5.2　请求调度"></a>2.5.2　请求调度</h5><p>程序收到客户端发来的请求时，要找到处理该请求的视图函数。为了完成这个任务，Flask<br>会在程序的 URL 映射中查找请求的 URL。URL 映射是 URL 和视图函数之间的对应关系。<br>Flask 使用 app.route 修饰器或者非修饰器形式的 app.add_url_rule() 生成映射。</p>
<h5 id="2-5-3-请求钩子"><a href="#2-5-3-请求钩子" class="headerlink" title="2.5.3　请求钩子"></a>2.5.3　请求钩子</h5><p>有时在处理请求之前或之后执行代码会很有用</p>
<ul>
<li>before_first_request：注册一个函数，在处理第一个请求之前运行。</li>
<li>before_request：注册一个函数，在每次请求之前运行。</li>
<li>after_request：注册一个函数，如果没有未处理的异常抛出，在每次请求之后运行。</li>
<li>teardown_request：注册一个函数，即使有未处理的异常抛出，也在每次请求之后运行。</li>
</ul>
<h5 id="2-5-4-响应"><a href="#2-5-4-响应" class="headerlink" title="2.5.4　响应"></a>2.5.4　响应</h5><p>Flask 调用视图函数后，会将其返回值作为响应的内容。大多数情况下，响应就是一个简<br>单的字符串，作为 HTML 页面回送客户端。</p>
<p>但 HTTP 协议需要的不仅是作为请求响应的字符串。HTTP 响应中一个很重要的部分是状<br>态码，Flask 默认设为 200，这个代码表明请求已经被成功处理。</p>
<h4 id="3-1-Jinja2模板引擎"><a href="#3-1-Jinja2模板引擎" class="headerlink" title="3.1 Jinja2模板引擎"></a>3.1 Jinja2模板引擎</h4><h5 id="3-1-1-渲染模板"><a href="#3-1-1-渲染模板" class="headerlink" title="3.1.1　渲染模板"></a>3.1.1　渲染模板</h5><p>Flask 提供的 render_template 函数把 Jinja2 模板引擎集成到了程序中。render_template 函<br>数的第一个参数是模板的文件名</p>
<h5 id="3-1-2-变量"><a href="#3-1-2-变量" class="headerlink" title="3.1.2　变量"></a>3.1.2　变量</h5><p>在模板中使用的  结构表示一个变量，它是一种特殊的占位符，告诉模<br>板引擎这个位置的值从渲染模板时使用的数据中获取。</p>
<p>Jinja2 能识别所有类型的变量，甚至是一些复杂的类型，例如列表、字典和对象。在模板</p>
<p>可以使用过滤器修改变量，过滤器名添加在变量名之后，中间使用竖线分隔。例如，下述<br>模板以首字母大写形式显示变量 name 的值：<br>    Hello, </p>
<h5 id="3-1-3-控制结构"><a href="#3-1-3-控制结构" class="headerlink" title="3.1.3　控制结构"></a>3.1.3　控制结构</h5><p>下面这个例子展示了如何在模板中使用条件控制语句：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> user %&#125;</span><span class="xml"></span></div><div class="line"> Hello, <span class="template-variable">&#123;&#123; user &#125;&#125;</span><span class="xml">!</span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></div><div class="line"> Hello, Stranger!</div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>另一种常见需求是在模板中渲染一组元素。下例展示了如何使用 for 循环实现这一需求：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> comment <span class="keyword">in</span> comments %&#125;</span><span class="xml"></span></div><div class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="template-variable">&#123;&#123; comment &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></div><div class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Jinja2 还支持宏。宏类似于 Python 代码中的函数。</p>
<p>需要在多处重复使用的模板代码片段可以写入单独的文件，再包含在所有模板中，以避免<br>重复：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> 'common.html' %&#125;</span><span class="xml"></span></div></pre></td></tr></table></figure>
<h5 id="3-2-使用Flask-Bootstrap集成Twitter-Bootstrap"><a href="#3-2-使用Flask-Bootstrap集成Twitter-Bootstrap" class="headerlink" title="3.2　使用Flask-Bootstrap集成Twitter Bootstrap"></a>3.2　使用Flask-Bootstrap集成Twitter Bootstrap</h5><p>Bootstrap（<a href="http://getbootstrap.com/）是" target="_blank" rel="external">http://getbootstrap.com/）是</a> Twitter 开发的一个开源框架，它提供的用户界面组<br>件可用于创建整洁且具有吸引力的网页，而且这些网页还能兼容所有现代 Web 浏览器。</p>
<h5 id="3-3-自定义错误页面"><a href="#3-3-自定义错误页面" class="headerlink" title="3.3　自定义错误页面"></a>3.3　自定义错误页面</h5><p>像常规路由一样，Flask 允许程序使用基于模板的自定义错误页面。最常见的错误代码有<br>两个：404，客户端请求未知页面或路由时显示；500，有未处理的异常时显示。为这两个<br>错误代码指定自定义处理程序的方式如示例 3-6 所示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.errorhandler(404)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(e)</span>:</span></div><div class="line"> <span class="keyword">return</span> render_template(<span class="string">'404.html'</span>), <span class="number">404</span></div><div class="line"><span class="meta">@app.errorhandler(500)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">internal_server_error</span><span class="params">(e)</span>:</span></div><div class="line"> <span class="keyword">return</span> render_template(<span class="string">'500.html'</span>), <span class="number">500</span></div></pre></td></tr></table></figure>
<p>3.4　链接<br>在模板中直接编写简单路由的 URL 链接不难，但对于包含可变部分的动态路由，在模板<br>中构建正确的 URL 就很困难。<strong>而且，直接编写 URL 会对代码中定义的路由产生不必要的<br>依赖关系。如果重新定义路由，模板中的链接可能会失效。</strong></p>
<p>为了避免这些问题，Flask 提供了 <strong>url_for()</strong> 辅助函数，它可以使用程序 URL 映射中保存的信息生成 URL。</p>
<h5 id="3-5-静态文件"><a href="#3-5-静态文件" class="headerlink" title="3.5　静态文件"></a>3.5　静态文件</h5><p>默认设置下，Flask 在程序根目录中名为 static 的子目录中寻找静态文件。如果需要，可在static 文件夹中使用子文件夹存放文件。</p>
<h5 id="3-6-使用Flask-Moment本地化日期和时间"><a href="#3-6-使用Flask-Moment本地化日期和时间" class="headerlink" title="3.6　使用Flask-Moment本地化日期和时间"></a>3.6　使用Flask-Moment本地化日期和时间</h5><p>服务器需要统一时间单位，这和用户所在的地理位置无关，所以一般使用协调世界时<br>（Coordinated Universal Time，UTC）.不过用户看到 UTC 格式的时间会感到困惑，他们更希望看到当地时间，而且采用当地惯用的格式。</p>
<p>一个优雅的解决方案是，把时间单位发送给 Web 浏览器，转换成当地时间，然后渲染。</p>
<h5 id="4-1-跨站请求伪造保护"><a href="#4-1-跨站请求伪造保护" class="headerlink" title="4.1　跨站请求伪造保护"></a>4.1　跨站请求伪造保护</h5><p>默认情况下，Flask-WTF 能保护所有表单免受跨站请求伪造（Cross-Site Request Forgery，<br>CSRF）的攻击。恶意网站把请求发送到被攻击者已登录的其他网站时就会引发 CSRF 攻击。</p>
<p>为了实现 CSRF 保护，Flask-WTF 需要程序设置一个密钥。Flask-WTF 使用这个密钥生成<br>加密令牌，再用令牌验证请求中表单数据的真伪。设置密钥的方法如示例 4-1 所示。</p>
<h5 id="4-2-表单类"><a href="#4-2-表单类" class="headerlink" title="4.2　表单类"></a>4.2　表单类</h5><p>使用 Flask-WTF 时，每个 Web 表单都由一个继承自 Form 的类表示。这</p>
<h5 id="4-3-把表单渲染成HTML"><a href="#4-3-把表单渲染成HTML" class="headerlink" title="4.3　把表单渲染成HTML"></a>4.3　把表单渲染成HTML</h5><p>表单字段是可调用的，在模板中调用后会渲染成 HTML。假设视图函数把一个 NameForm 实例通过参数 form 传入模板，在模板中可以生成一个简单的表单，如下所示：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="selector-tag">form</span> method=<span class="string">"POST"</span>&gt;</div><div class="line"> &#123;&#123; <span class="selector-tag">form</span>.hidden_tag() &#125;&#125;</div><div class="line"> &#123;&#123; <span class="selector-tag">form</span><span class="selector-class">.name</span><span class="selector-class">.label</span> &#125;&#125; &#123;&#123; <span class="selector-tag">form</span>.name() &#125;&#125;</div><div class="line"> &#123;&#123; <span class="selector-tag">form</span>.submit() &#125;&#125;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>
<h5 id="4-4-在视图函数中处理表单"><a href="#4-4-在视图函数中处理表单" class="headerlink" title="4.4　在视图函数中处理表单"></a>4.4　在视图函数中处理表单</h5><p>不仅要渲染表单，还要接收表单中的数据</p>
<h5 id="4-5-重定向和用户会话"><a href="#4-5-重定向和用户会话" class="headerlink" title="4.5　重定向和用户会话"></a>4.5　重定向和用户会话</h5><p>程序可以把数据存储在用户会话中，在请求之间“记住”数据。用户会话是一种私有存储，存在于每个连接到服务器的客户端中</p>
<h5 id="4-6-Flash消息"><a href="#4-6-Flash消息" class="headerlink" title="4.6 Flash消息"></a>4.6 Flash消息</h5><p>请求完成后，有时需要让用户知道状态发生了变化。这里可以使用确认消息、警告或者错误提醒。</p>
<p>仅调用 flash() 函数并不能把消息显示出来，程序使用的模板要渲染这些消息。最好在基模板中渲染Flash 消息，因为这样所有页面都能使用这些消息。Flask 把get_flashed_messages() 函数开放给模板，用来获取并渲染消息</p>
<h5 id="5-1-SQL数据库"><a href="#5-1-SQL数据库" class="headerlink" title="5.1 SQL数据库"></a>5.1 SQL数据库</h5><p>关系型数据库把数据存储在表中，表模拟程序中不同的实体。</p>
<p>表的列数是固定的，行数是可变的。列定义表所表示的实体的数据属性。</p>
<p>表中有个特殊的列，称为<em>主键</em>，其值为表中各行的唯一标识符。表中还可以有称为<em>外键</em>的列，引用同一个表或不同表中某行的主键。行之间的这种联系称为关系，这是关系型数据库模型的基础。</p>
<h5 id="5-2-NoSQL数据库"><a href="#5-2-NoSQL数据库" class="headerlink" title="5.2 NoSQL数据库"></a>5.2 NoSQL数据库</h5><p>所有不遵循上节所述的关系模型的数据库统称为 NoSQL 数据库。</p>
<p><em>使用 NoSQL 数据库当然也有好处。数据重复可以提升查询速度。列出用户及其角色的操作很简单，因为无需联结</em></p>
<h5 id="5-3-使用SQL还是NoSQL"><a href="#5-3-使用SQL还是NoSQL" class="headerlink" title="5.3　使用SQL还是NoSQL"></a>5.3　使用SQL还是NoSQL</h5><p>SQL 数据库擅于用高效且紧凑的形式存储结构化数据。这种数据库需要花费大量精力保证数据的一致性。NoSQL 数据库放宽了对这种一致性的要求，从而获得性能上的优势。</p>
<h5 id="5-4-Python数据库框架"><a href="#5-4-Python数据库框架" class="headerlink" title="5.4 Python数据库框架"></a>5.4 Python数据库框架</h5><p>Flask 并不限制你使<br>用何种类型的数据库包，因此可以根据自己的喜好选择使用 MySQL、Postgres、SQLite、Redis、MongoDB 或者 CouchDB。</p>
<ol>
<li>易用性</li>
<li>性能</li>
<li>可移植性</li>
</ol>
<h5 id="5-5-使用Flask-SQLAlchemy管理数据库"><a href="#5-5-使用Flask-SQLAlchemy管理数据库" class="headerlink" title="5.5　使用Flask-SQLAlchemy管理数据库"></a>5.5　使用Flask-SQLAlchemy管理数据库</h5><p>Flask-SQLAlchemy 是一个 Flask 扩展，简化了在 Flask 程序中使用 SQLAlchemy 的操作。</p>
<h5 id="5-6-定义模型"><a href="#5-6-定义模型" class="headerlink" title="5.6　定义模型"></a>5.6　定义模型</h5><p><em>模型</em>这个术语表示程序使用的持久化实体。</p>
<h5 id="5-7-关系"><a href="#5-7-关系" class="headerlink" title="5.7　关系"></a>5.7　关系</h5><p>关系型数据库使用关系把不同表中的行联系起来。</p>
<h5 id="5-8-数据库操作"><a href="#5-8-数据库操作" class="headerlink" title="5.8　数据库操作"></a>5.8　数据库操作</h5><h6 id="5-8-1-创建表"><a href="#5-8-1-创建表" class="headerlink" title="5.8.1　创建表"></a>5.8.1　创建表</h6><p>方法是使用 db.create_all()</p>
<h6 id="5-8-2-插入行"><a href="#5-8-2-插入行" class="headerlink" title="5.8.2　插入行"></a>5.8.2　插入行</h6><p>db.session.add(admin_role)</p>
<h6 id="5-8-3-修改行"><a href="#5-8-3-修改行" class="headerlink" title="5.8.3　修改行"></a>5.8.3　修改行</h6><p>db.session.add(admin_role)<br>db.session.commit()</p>
<h6 id="5-8-4-删除行"><a href="#5-8-4-删除行" class="headerlink" title="5.8.4　删除行"></a>5.8.4　删除行</h6><p>db.session.delete(mod_role)<br>db.session.commit()</p>
<h6 id="5-8-5-查询行"><a href="#5-8-5-查询行" class="headerlink" title="5.8.5　查询行"></a>5.8.5　查询行</h6><p>Flask-SQLAlchemy 为每个模型类都提供了 query 对象</p>
<h5 id="5-9-在视图函数中操作数据库"><a href="#5-9-在视图函数中操作数据库" class="headerlink" title="5.9　在视图函数中操作数据库"></a>5.9　在视图函数中操作数据库</h5><h5 id="5-10-集成Python-shell"><a href="#5-10-集成Python-shell" class="headerlink" title="5.10　集成Python shell"></a>5.10　集成Python shell</h5><p>每次启动 shell 会话都要导入数据库实例和模型，这真是份枯燥的工作。为了避免一直重复导入，我们可以做些配置，让 Flask-Script 的 shell 命令自动导入特定的对象。</p>
<h5 id="5-11-使用Flask-Migrate实现数据库迁移"><a href="#5-11-使用Flask-Migrate实现数据库迁移" class="headerlink" title="5.11　使用Flask-Migrate实现数据库迁移"></a>5.11　使用Flask-Migrate实现数据库迁移</h5><h5 id="7-1-项目结构"><a href="#7-1-项目结构" class="headerlink" title="7.1　项目结构"></a>7.1　项目结构</h5><p>多文件 Flask 程序的基本结构</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="string">|-flasky</span></div><div class="line"> <span class="string">|-app/</span></div><div class="line"> 	<span class="string">|-templates/</span></div><div class="line"> 	<span class="string">|-static/</span></div><div class="line"> 	<span class="string">|-main/</span></div><div class="line"> 		<span class="string">|-__init__.py</span></div><div class="line"> 		<span class="string">|-errors.py</span></div><div class="line"> 		<span class="string">|-forms.py</span></div><div class="line"> 		<span class="string">|-views.py</span></div><div class="line"> 	<span class="string">|-__init__.py</span></div><div class="line"> 	<span class="string">|-email.py</span></div><div class="line"> 	<span class="string">|-models.py</span></div><div class="line"> <span class="string">|-migrations/</span></div><div class="line"> <span class="string">|-tests/</span></div><div class="line"> 	<span class="string">|-__init__.py</span></div><div class="line">  	<span class="string">|-test*.py</span></div><div class="line"> <span class="string">|-venv/</span></div><div class="line"> <span class="string">|-requirements.txt</span></div><div class="line"> <span class="string">|-config.py</span></div><div class="line"> <span class="string">|-manage.py</span></div></pre></td></tr></table></figure>
<p>这种结构有 4 个顶级文件夹：</p>
<ul>
<li>Flask 程序一般都保存在名为 app 的包中；</li>
<li>和之前一样，migrations 文件夹包含数据库迁移脚本；</li>
<li>单元测试编写在 tests 包中；</li>
<li>和之前一样，venv 文件夹包含 Python 虚拟环境</li>
</ul>
<p>同时还创建了一些新文件：</p>
<ul>
<li>requirements.txt 列出了所有依赖包，便于在其他电脑中重新生成相同的虚拟环境；</li>
<li>requirements.txt 列出了所有依赖包，便于在其他电脑中重新生成相同的虚拟环境；</li>
<li>manage.py 用于启动程序以及其他的程序任务。</li>
</ul>
<h5 id="7-2-配置选项"><a href="#7-2-配置选项" class="headerlink" title="7.2　配置选项"></a>7.2　配置选项</h5><p>程序经常需要设定多个配置。这方面最好的例子就是开发、测试和生产环境要使用不同的数据库，这样才不会彼此影响。</p>
<h5 id="7-3-程序包"><a href="#7-3-程序包" class="headerlink" title="7.3　程序包"></a>7.3　程序包</h5><p>程序包用来保存程序的所有代码、模板和静态文件。我们可以把这个包直接称为app</p>
<h5 id="7-3-1-使用程序工厂函数"><a href="#7-3-1-使用程序工厂函数" class="headerlink" title="7.3.1　使用程序工厂函数"></a>7.3.1　使用程序工厂函数</h5><p>在单个文件中开发程序很方便，但却有个很大的缺点，因为程序在全局作用域中创建，所以无法动态修改配置。运行脚本时，程序实例已经创建，再修改配置为时已晚。这一点对单元测试尤其重要，因为有时为了提高测试覆盖度，必须在不同的配置环境中运行程序。</p>
<p>这个问题的解决方法是延迟创建程序实例，把创建过程移到可显式调用的工厂函数中。这种方法不仅可以给脚本留出配置程序的时间，还能够创建多个程序实例，这些实例有时在测试中非常有用。</p>
<h5 id="7-3-2-在蓝本中实现程序功能"><a href="#7-3-2-在蓝本中实现程序功能" class="headerlink" title="7.3.2　在蓝本中实现程序功能"></a>7.3.2　在蓝本中实现程序功能</h5><p>蓝本和程序类似，也可以定义路由。不同的<br>是，在蓝本中定义的路由处于休眠状态，直到蓝本注册到程序上后，路由才真正成为程序的一部分。使用位于全局作用域中的蓝本时，定义路由的方法几乎和单脚本程序一样。</p>
<h5 id="7-4-启动脚本"><a href="#7-4-启动脚本" class="headerlink" title="7.4　启动脚本"></a>7.4　启动脚本</h5><p>顶级文件夹中的 manage.py 文件用于启动程序。</p>
<h5 id="7-5-需求文件"><a href="#7-5-需求文件" class="headerlink" title="7.5　需求文件"></a>7.5　需求文件</h5><p>程序中必须包含一个 requirements.txt 文件，用于记录所有依赖包及其精确的版本号。如果要在另一台电脑上重新生成虚拟环境，这个文件的重要性就体现出来了，例如部署程序时使用的电脑。pip 可以使用如下命令自动生成这个文件：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(venv) <span class="variable">$ </span>pip freeze &gt;requirements.txt</div></pre></td></tr></table></figure>
<h5 id="7-6-单元测试"><a href="#7-6-单元测试" class="headerlink" title="7.6　单元测试"></a>7.6　单元测试</h5><h5 id="7-7-创建数据库"><a href="#7-7-创建数据库" class="headerlink" title="7.7　创建数据库"></a>7.7　创建数据库</h5><h5 id="8-1-Flask的认证扩展"><a href="#8-1-Flask的认证扩展" class="headerlink" title="8.1 Flask的认证扩展"></a>8.1 Flask的认证扩展</h5><h5 id="8-2-密码安全性"><a href="#8-2-密码安全性" class="headerlink" title="8.2　密码安全性"></a>8.2　密码安全性</h5>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/21/android_interface_definition_language/" itemprop="url">
                  AIDL 官方使用介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-11-21T14:09:00+08:00" content="2016-11-21">
              2016-11-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Android-Interface-Definition-Language-AIDL"><a href="#Android-Interface-Definition-Language-AIDL" class="headerlink" title="Android Interface Definition Language (AIDL)"></a>Android Interface Definition Language (AIDL)</h1><p>AIDL是允许你完成自定义接口，用于不同进程中服务器和客户端之间的通讯。主要是因为Android不允许你直接跨进程间传递消息，所以需要通过AIDL把传递的对象分解包装为操作系统可以接受的对象。</p>
<blockquote>
<p>当你的Service提供跨进程通讯，而且在服务中做多线程处理时你可以使用AIDL。如果当前的Service不准备提供给其他进程服务端做访问你只需要在服务中实现自定义的binder即可。或者你想实现IPC（进程间通讯），Service内又不需要做多线程管理，这种情况下你只要使用Messager。当然要合理选择哪一种方式的前提是你清楚了解如何绑定一Service；</p>
</blockquote>
<p>设计AIDL接口时，要知道你在什么情景下才需要调用你这个接口</p>
<ul>
<li>如果只是本地进程中调用这个接口，完全没必要使用AIDL,这时候只要在服务中实现binder即可</li>
<li>提供接口给远程进程，这时候可能接受远程中不同的线程访问你的接口，换句话说，你要在你的接口中保证线程的安全</li>
<li>The oneway keyword modifies the behavior of remote calls. When used, a remote call does not block; it simply sends the transaction data and immediately returns. The implementation of the interface eventually receives this as a regular call from the Binder thread pool as a normal remote call. If oneway is used with a local call, there is no impact and the call is still synchronous.</li>
</ul>
<h2 id="定义AIDL接口"><a href="#定义AIDL接口" class="headerlink" title="定义AIDL接口"></a>定义AIDL接口</h2><p>使用java语法在源码目录中创建你的 <em>.aidl</em> 文件</p>
<p>当你在应用中创建了 <em>.aidl</em> 文件，Android SDK tools 会基于这个文件自动为我们在 <em>gen/</em> 目录中生成IBinder对象。这样客户端就可以通过IBinder实现IPC通讯</p>
<p>通过AIDL绑定服务的如下步骤：</p>
<ol>
<li>创建 <em>.aidl</em> 文件</li>
<li><p>实现接口</p>
<p> 文件自动创建接口文件，内部Stub类必须继承Binder，实现Stubd方法内的行为</p>
</li>
<li><p>对客户端暴露接口</p>
<p> 实现的Service重写 onBind()方法 返回你实现的stub类</p>
</li>
</ol>
<blockquote>
<p>aidl文件的做了任何的改变，切记修改使用你服务的客户端</p>
</blockquote>
<h3 id="1-创建-aidl-文件"><a href="#1-创建-aidl-文件" class="headerlink" title="1.创建 .aidl 文件"></a>1.创建 <em>.aidl</em> 文件</h3><p><strong>IRemoteService.aidl</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.example.administrator.aidl.AIDL;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.example.administrator.aidl.AIDL.IRemoteServiceCallback;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Demonstrates some basic types that you can use as parameters</div><div class="line">     * and return values in AIDL.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerCallback</span><span class="params">(IRemoteServiceCallback cb)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregisterCallback</span><span class="params">(IRemoteServiceCallback cb)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>ISecondary.aidl</strong><br><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// ISecondary.aidl</div><div class="line"><span class="keyword">package</span> <span class="title">com.example.admin</span>istrator.aidl.AIDL;</div><div class="line"></div><div class="line">// <span class="keyword">Declare</span> any non-default types here <span class="keyword">with</span> import statements</div><div class="line"></div><div class="line"><span class="keyword">interface</span> ISecondary &#123;</div><div class="line">    /**</div><div class="line">     * Demonstrates <span class="keyword">some</span> basic types that you can <span class="keyword">use</span> as parameters</div><div class="line">     * <span class="keyword">and</span> <span class="keyword">return</span> values <span class="keyword">in</span> AIDL.</div><div class="line">     */</div><div class="line"></div><div class="line">    int getPid();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>IRemoteServiceCallback.aidl</strong><br><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// IRemoteServiceCallback.aidl</div><div class="line"><span class="keyword">package</span> <span class="title">com.example.admin</span>istrator.aidl.AIDL;</div><div class="line"></div><div class="line">// <span class="keyword">Declare</span> any non-default types here <span class="keyword">with</span> import statements</div><div class="line"></div><div class="line"><span class="keyword">interface</span> IRemoteServiceCallback &#123;</div><div class="line">    /**</div><div class="line">     * Demonstrates <span class="keyword">some</span> basic types that you can <span class="keyword">use</span> as parameters</div><div class="line">     * <span class="keyword">and</span> <span class="keyword">return</span> values <span class="keyword">in</span> AIDL.</div><div class="line">     */</div><div class="line">    void valueChanged(int value);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="实现-aidl-文件中的接口-如实现-IRemoteService-aidl-和-ISecondary-aidl-接口"><a href="#实现-aidl-文件中的接口-如实现-IRemoteService-aidl-和-ISecondary-aidl-接口" class="headerlink" title="实现 .aidl 文件中的接口,如实现 IRemoteService.aidl 和 ISecondary.aidl 接口"></a>实现 <em>.aidl</em> 文件中的接口,如实现 <em>IRemoteService.aidl</em> 和 <em>ISecondary.aidl</em> 接口</h3><p>创建 <em>.aidl</em> 文件时，Android skd Tool 会自动对应的java文件，其中会生成一个继承Binder抽象内部类 <em>Stub</em> 。所以在服务中继承Stub，实现自己的内部方法，例如下面RemoteService中 mBinder和mSecondaryBinder中的实现</p>
<h3 id="暴露你的接口，例如在例如下面RemoteService中OnBind的方法中，把实现的对象返回给客户端程序"><a href="#暴露你的接口，例如在例如下面RemoteService中OnBind的方法中，把实现的对象返回给客户端程序" class="headerlink" title="暴露你的接口，例如在例如下面RemoteService中OnBind的方法中，把实现的对象返回给客户端程序"></a>暴露你的接口，例如在例如下面RemoteService中OnBind的方法中，把实现的对象返回给客户端程序</h3><p><strong>RemoteService</strong><br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function">IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (IRemoteService.class.getName().equals(intent.getAction())) &#123;</div><div class="line">            <span class="keyword">return</span> mBinder;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (ISecondary.class.getName().equals(intent.getAction())) &#123;</div><div class="line">            <span class="keyword">return</span> mSecondaryBinder;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IRemoteService.Stub mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">registerCallback</span><span class="params">(IRemoteServiceCallback cb)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">                cb.valueChanged(mSecondaryBinder.getPid());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">unregisterCallback</span><span class="params">(IRemoteServiceCallback cb)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ISecondary.Stub mSecondaryBinder = <span class="keyword">new</span> ISecondary.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">getPid</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="function"><span class="keyword">return</span> Process.<span class="title">myPid</span><span class="params">()</span></span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="绑定方法如同bind方法一样，bindService-intent-mConnection-Context-BIND-AUTO-CREATE"><a href="#绑定方法如同bind方法一样，bindService-intent-mConnection-Context-BIND-AUTO-CREATE" class="headerlink" title="绑定方法如同bind方法一样，bindService(intent, mConnection, Context.BIND_AUTO_CREATE);"></a>绑定方法如同bind方法一样，bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Binding</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUMP_MSG = <span class="number">1</span>;</div><div class="line">    TextView mCallbackText;</div><div class="line">    IRemoteService mService;</div><div class="line">    Button mKillButton;</div><div class="line">    Boolean mIsBound;</div><div class="line">    ISecondary mSecondaryService;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.aidl_layout);</div><div class="line"></div><div class="line">        Button bindbutton = (Button) findViewById(R.id.bind);</div><div class="line"></div><div class="line">        bindbutton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                Intent intent = <span class="keyword">new</span> Intent(Binding.<span class="keyword">this</span>, RemoteService.class);</div><div class="line">                intent.setAction(IRemoteService.class.getName());</div><div class="line">                bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line"></div><div class="line">                intent.setAction(ISecondary.class.getName());</div><div class="line">                bindService(intent, mSecondaryConnection, Context.BIND_AUTO_CREATE);</div><div class="line">                mCallbackText.setText(<span class="string">"Binding."</span>);</div><div class="line">                mIsBound = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        Button unbindbutton = (Button) findViewById(R.id.unbind);</div><div class="line">        unbindbutton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mIsBound) &#123;</div><div class="line">                    <span class="keyword">if</span> (mService != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            mService.unregisterCallback(mCallback);</div><div class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                        unbindService(mConnection);</div><div class="line">                        mKillButton.setEnabled(<span class="keyword">false</span>);</div><div class="line">                        mIsBound = <span class="keyword">false</span>;</div><div class="line">                        mCallbackText.setText(<span class="string">"Unbinding"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mKillButton = (Button) findViewById(R.id.kill);</div><div class="line">        mKillButton.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mSecondaryService != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">int</span> pid = mSecondaryService.getPid();</div><div class="line">                        Process.killProcess(pid);</div><div class="line">                        mCallbackText.setText(<span class="string">"Killed service process."</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                        Toast.makeText(Binding.<span class="keyword">this</span>,</div><div class="line">                                R.string.remote_call_failed,</div><div class="line">                                Toast.LENGTH_SHORT).show();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mKillButton.setEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        mCallbackText = (TextView) findViewById(R.id.callback);</div><div class="line">        mCallbackText.setText(<span class="string">"Not attached."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">            Log.e(<span class="string">"TAG"</span>,<span class="string">"connected"</span>);</div><div class="line">            mService = IRemoteService.Stub.asInterface(iBinder);</div><div class="line">            mKillButton.setEnabled(<span class="keyword">true</span>);</div><div class="line">            mCallbackText.setText(<span class="string">"Attached"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mService.registerCallback(mCallback);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            Toast.makeText(Binding.<span class="keyword">this</span>, R.string.remote_service_connected,</div><div class="line">                    Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">            mService = <span class="keyword">null</span>;</div><div class="line">            mKillButton.setEnabled(<span class="keyword">false</span>);</div><div class="line">            mCallbackText.setText(<span class="string">"Disconnected."</span>);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ServiceConnection mSecondaryConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">            mSecondaryService = ISecondary.Stub.asInterface(iBinder);</div><div class="line">            mKillButton.setEnabled(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">            mSecondaryService = <span class="keyword">null</span>;</div><div class="line">            mKillButton.setEnabled(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> IRemoteServiceCallback mCallback = <span class="keyword">new</span> IRemoteServiceCallback.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">valueChanged</span><span class="params">(<span class="keyword">int</span> value)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            mHandler.sendMessage(mHandler.obtainMessage(BUMP_MSG, value, <span class="number">0</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> BUMP_MSG:</div><div class="line">                    mCallbackText.setText(<span class="string">"Received from service: "</span> + msg.arg1);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        <span class="keyword">if</span>(mService!=<span class="keyword">null</span>)&#123;</div><div class="line">            unbindService(mConnection);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="IPC传递对象"><a href="#IPC传递对象" class="headerlink" title="IPC传递对象"></a>IPC传递对象</h3><ol>
<li>传递的对象实现Parcelable接口</li>
<li>在对象的类中实现 writeToParcel方法</li>
<li>添加一个静态变量CREATOR并且实现Parcelable.Creator 的接口</li>
<li>在目录中添加一个.aidl文件声明上面所创建的parcelable 类,列如如下</li>
</ol>
<p>Rect.aidl<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">package android.graphics<span class="comment">;</span></div><div class="line">parcelable Rect<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>这里创建我们的Rect类，并实现现Parcelable接口，类中再实现writeToParcel方法，静态变量CREATOR</p>
<p>Rect.java<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Rect</span> <span class="title">implements</span> <span class="title">Parcelable</span> &#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> left;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> top;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> right;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> bottom;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> final Parcelable.Creator&lt;Rect&gt; CREATOR = <span class="keyword">new</span> Creator&lt;Rect&gt;() &#123;</div><div class="line">        @<span class="function">Override</span></div><div class="line">        <span class="keyword">public</span> Rect <span class="title">createFromParcel</span>(<span class="params">Parcel parcel</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Rect(parcel);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @<span class="function">Override</span></div><div class="line">        <span class="keyword">public</span> Rect[] <span class="title">newArray</span>(<span class="params"><span class="keyword">int</span> i</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Rect[i];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rect</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Rect</span>(<span class="params">Parcel <span class="keyword">in</span></span>) </span>&#123;</div><div class="line">        readFromParcel(<span class="keyword">in</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @<span class="function">Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span>(<span class="params"></span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @<span class="function">Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span>(<span class="params">Parcel parcel, <span class="keyword">int</span> i</span>) &#123;</div><div class="line">        parcel.writeInt(left);</div><div class="line">        parcel.writeInt(top);</div><div class="line">        parcel.writeInt(right);</div><div class="line">        parcel.writeInt(bottom);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span>(<span class="params">Parcel <span class="keyword">in</span></span>) </span>&#123;</div><div class="line">        left = <span class="keyword">in</span>.readInt();</div><div class="line">        top = <span class="keyword">in</span>.readInt();</div><div class="line">        right = <span class="keyword">in</span>.readInt();</div><div class="line">        bottom = <span class="keyword">in</span>.readInt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 IRemoteService.aidl添加下面的接口<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Rect getRect()<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>在RemoteService.java中的mBinder对象中实现以下方法，这里我们对服务返回的对象进行赋值<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">       <span class="keyword">public</span> Rect getRect() <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">           Rect <span class="built_in">rect</span> = <span class="keyword">new</span> Rect();</div><div class="line">           <span class="built_in">rect</span>.bottom = <span class="number">10</span>;</div><div class="line">           <span class="built_in">rect</span>.top = <span class="number">10</span>;</div><div class="line">           <span class="built_in">rect</span>.left = <span class="number">5</span>;</div><div class="line">           <span class="built_in">rect</span>.right = <span class="number">6</span>;</div><div class="line">           <span class="keyword">return</span> <span class="built_in">rect</span>;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>这样我们便可以在客户端中先服务获取我的对象，具体在Bindnd.java中的mConnection得到Rect对象，如下<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</div><div class="line">         Log.e(<span class="string">"TAG"</span>, <span class="string">"connected"</span>);</div><div class="line">         mService = IRemoteService.Stub.asInterface(iBinder);</div><div class="line">         mKillButton.setEnabled(<span class="keyword">true</span>);</div><div class="line">         mCallbackText.setText(<span class="string">"Attached"</span>);</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             <span class="comment">//获取到服务端中的Rect对象</span></div><div class="line">             android.graphics.Rect rectFromService = mService.getRect();</div><div class="line">             Log.e(<span class="string">"TAG"</span>,<span class="string">"bottom = "</span>+rectFromService.bottom+<span class="string">",top = "</span>+rectFromService.top+<span class="string">",left = "</span>+rectFromService.left+<span class="string">",right ="</span>+rectFromService.right);</div><div class="line">             mService.registerCallback(mCallback);</div><div class="line">         &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">             e.printStackTrace();</div><div class="line">         &#125;</div><div class="line">         Toast.makeText(Binding.<span class="keyword">this</span>, R.string.remote_service_connected,</div><div class="line">                 Toast.LENGTH_SHORT).show();</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</div><div class="line">         mService = <span class="keyword">null</span>;</div><div class="line">         mKillButton.setEnabled(<span class="keyword">false</span>);</div><div class="line">         mCallbackText.setText(<span class="string">"Disconnected."</span>);</div><div class="line"></div><div class="line">     &#125;</div><div class="line"> &#125;;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/21/okhttp_analyse/" itemprop="url">
                  Okhttp 源码解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-11-21T14:09:00+08:00" content="2016-11-21">
              2016-11-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Okhttp解析"><a href="#Okhttp解析" class="headerlink" title="Okhttp解析"></a>Okhttp解析</h1><h3 id="总体思想"><a href="#总体思想" class="headerlink" title="总体思想"></a>总体思想</h3><p>分析源码，首先要熟悉用例，由上到下一层一层剥开源码，初步了解项目的框架，然后再细看代码的实现细节。现在试着分析 OKhttp 的源码，下面代码是来至 <a href="https://square.github.io/okhttp/#examples" target="_blank" rel="external">OKhttp官网</a>。</p>
<p>GET A URL</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="type">OkHttpClient</span> client = <span class="function"><span class="keyword">new</span> <span class="title">OkHttpClient</span>(); <span class="comment">//(1)</span></span></div><div class="line"></div><div class="line"><span class="title">String</span> <span class="title">run</span>(<span class="type">String</span> url) <span class="title">throws</span> <span class="title">IOException</span> &#123;</div><div class="line">  <span class="title">Request</span> <span class="title">request</span> = <span class="title">new</span> <span class="title">Request</span>.<span class="title">Builder</span>()</div><div class="line">      .<span class="title">url</span>(url)</div><div class="line">      .<span class="title">build</span>();                           <span class="comment">//(2)</span></div><div class="line"></div><div class="line">  <span class="title">Response</span> <span class="title">response</span> = <span class="title">client</span>.<span class="title">newCall</span>(request).<span class="title">execute</span>();  <span class="comment">//(3)</span></div><div class="line">  <span class="title">return</span> <span class="title">response</span>.<span class="title">body</span>().<span class="title">string</span>();                        <span class="comment">//(4)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建一个 OkHttpClient 对象。</li>
<li>创建一个 Request 对象，可以设置 URL 等网络配置。</li>
<li>调用 OkHttpClient 的 newCall() 方法，并把自定义配置的Request对象作为参数传进去。到处为止程序成功的将需要的请求放在了队列中，执行 execute() 方法开始向服务器发起请求，服务器返回的信息转化为 Response 对象。</li>
<li>返回 response 对象的 body 主体信息。</li>
</ol>
<p>一张来至<a href="http://blog.piasy.com/" target="_blank" rel="external">piasy</a>的流程图:<br><img src="http://blog.piasy.com/img/201607/okhttp_full_process.png" alt="image"></p>
<h3 id="细节分析"><a href="#细节分析" class="headerlink" title="细节分析"></a>细节分析</h3><h4 id="创建-OkHttpClient-对象"><a href="#创建-OkHttpClient-对象" class="headerlink" title="创建 OkHttpClient 对象"></a>创建 OkHttpClient 对象</h4><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">OkHttpClient <span class="keyword">client</span> = <span class="keyword">new</span> OkHttpClient();</div></pre></td></tr></table></figure>
<p>OkHttpClient.class 里面的两个构造函数：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> OkHttpClient() &#123;</div><div class="line">    <span class="keyword">this</span>(new Builder());</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"><span class="keyword">private</span> OkHttpClient(Builder builder) &#123;</div><div class="line">    <span class="keyword">this</span>.dispatcher = builder.dispatcher;</div><div class="line">    <span class="keyword">this</span>.proxy = builder.proxy;</div><div class="line">    <span class="keyword">this</span>.protocols = builder.protocols;</div><div class="line">    .</div><div class="line">    .</div><div class="line">    .</div><div class="line">    <span class="keyword">this</span>.retryOnConnectionFailure = builder.retryOnConnectionFailure;</div><div class="line">    <span class="keyword">this</span>.connectTimeout = builder.connectTimeout;</div><div class="line">    <span class="keyword">this</span>.readTimeout = builder.readTimeout;</div><div class="line">    <span class="keyword">this</span>.writeTimeout = builder.writeTimeout;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>上面可以看出，new OkHttpClient() 是调用 OkHttpClient.class 另外一个 private 的构造函数 OkHttpClient(Builder builder) ，其中 Builder 是 OkHttpClient 的一个内部类，Builder 是使用了<a href="https://www.tutorialspoint.com/design_pattern/builder_pattern.htm" target="_blank" rel="external">构造者模式</a>，里面包含了一些配置相关的字段如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Dispatcher dispatcher;  <span class="comment">//分发器</span></div><div class="line"><span class="keyword">final</span> Proxy proxy; <span class="comment">//代理</span></div><div class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;Protocol&gt; protocols; <span class="comment">//协议</span></div><div class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;ConnectionSpec&gt; connectionSpecs; <span class="comment">//传输层版本和连接协议</span></div><div class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;Interceptor&gt; interceptors; <span class="comment">//拦截器</span></div><div class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;Interceptor&gt; networkInterceptors; <span class="comment">//网络拦截器</span></div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line"><span class="keyword">final</span> <span class="built_in">int</span> readTimeout; <span class="comment">//read 超时</span></div><div class="line"><span class="keyword">final</span> <span class="built_in">int</span> writeTimeout; <span class="comment">//write 超时</span></div></pre></td></tr></table></figure>
<h4 id="创建-Request-对象"><a href="#创建-Request-对象" class="headerlink" title="创建 Request 对象"></a>创建 Request 对象</h4><p>创建完 OkHttpClient 对象后，就需要我们创建一个Request，Request 作用就是承载用户的请求，最简单的也是必须的做法是设置  Request 的 URL。同样和创建 OkHttpClient 对象一样，Request 也是使用 构造者模式，其中包含了 URL, header, body等字段，简单看看源码中的 Request 的构造函数：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Request(Builder builder) &#123;</div><div class="line">   <span class="keyword">this</span>.url = builder.url;</div><div class="line">   <span class="keyword">this</span>.method = builder.method;</div><div class="line">   <span class="keyword">this</span>.headers = builder.headers.build();</div><div class="line">   <span class="keyword">this</span>.body = builder.body;</div><div class="line">   <span class="keyword">this</span>.tag = builder.tag != <span class="literal">null</span> ? builder.tag : <span class="keyword">this</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h4 id="真正开始工作啦"><a href="#真正开始工作啦" class="headerlink" title="真正开始工作啦"></a>真正开始工作啦</h4><h5 id="同步请求"><a href="#同步请求" class="headerlink" title="同步请求"></a>同步请求</h5><p>最上面的官方示例代码是一个同步的网络请求，接着我们一步一步拆解代码。<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//官方示例代码</span></div><div class="line">Response response = <span class="keyword">client</span>.newCall(request).execute();</div></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//OkHttpClient.class</span></div><div class="line"><span class="function"><span class="keyword">public</span> Call <span class="title">newCall</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RealCall(<span class="keyword">this</span>, request);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Recall.class</span></div><div class="line">  <span class="keyword">protected</span> RealCall(OkHttpClient <span class="keyword">client</span>, Request originalRequest) &#123;</div><div class="line">    <span class="keyword">this</span>.<span class="keyword">client</span> = <span class="keyword">client</span>;</div><div class="line">    <span class="keyword">this</span>.originalRequest = originalRequest;</div><div class="line">    <span class="keyword">this</span>.retryAndFollowUpInterceptor = <span class="keyword">new</span> RetryAndFollowUpInterceptor(<span class="keyword">client</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">    @Override <span class="keyword">protected</span> <span class="keyword">void</span> execute() &#123;</div><div class="line">      <span class="keyword">boolean</span> signalledCallback = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        Response response = getResponseWithInterceptorChain();</div><div class="line">        <span class="keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          signalledCallback = <span class="keyword">true</span>;</div><div class="line">          responseCallback.onResponse(RealCall.<span class="keyword">this</span>, response);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="keyword">if</span> (signalledCallback) &#123;</div><div class="line">          <span class="comment">// Do not signal the callback twice!</span></div><div class="line">          Platform.get().log(INFO, <span class="string">"Callback failure for "</span> + toLoggableString(), e);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, e);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">client</span>.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在 OkhttpClient 代码里面看到，newCall() 函数返回一个 Call 对象，其实 Call 是一个接口，而我们的没一次请求都是转载在一个 Call 对象中。其中看到返回的是一个 RealCall 对象，由这里看到 RealCall 是 Call 的一个实现类。</p>
<p>Ok，接着看看 RealCall 对象的 execute() 方法，可以看到这样一行最重要的代码 Response response = getResponseWithInterceptorChain() ，通过这一个方法可得到从服务器返回的一个 Response 对象。从这个函数的名字可以推测，这是一个接一个的链式调用，接下来也可以从源码发现，这个地方使用了<a href="https://www.tutorialspoint.com/design_pattern/chain_of_responsibility_pattern.htm" target="_blank" rel="external">责任链模式</a></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//RealCall.call</span></div><div class="line"><span class="keyword">private</span> Response getResponseWithInterceptorChain() <span class="keyword">throws</span> IOException &#123;</div><div class="line">    <span class="comment">// Build a full stack of interceptors.</span></div><div class="line">    List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    interceptors.addAll(client.interceptors());</div><div class="line">    interceptors.<span class="built_in">add</span>(retryAndFollowUpInterceptor);</div><div class="line">    interceptors.<span class="built_in">add</span>(<span class="keyword">new</span> BridgeInterceptor(client.cookieJar()));</div><div class="line">    interceptors.<span class="built_in">add</span>(<span class="keyword">new</span> CacheInterceptor(client.internalCache()));</div><div class="line">    interceptors.<span class="built_in">add</span>(<span class="keyword">new</span> ConnectInterceptor(client));</div><div class="line">    <span class="keyword">if</span> (!retryAndFollowUpInterceptor.isForWebSocket()) &#123;</div><div class="line">      interceptors.addAll(client.networkInterceptors());</div><div class="line">    &#125;</div><div class="line">    interceptors.<span class="built_in">add</span>(<span class="keyword">new</span> CallServerInterceptor(</div><div class="line">        retryAndFollowUpInterceptor.isForWebSocket()));</div><div class="line"></div><div class="line">    Interceptor.Chain chain = <span class="keyword">new</span> RealInterceptorChain(</div><div class="line">        interceptors, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, originalRequest);</div><div class="line">    <span class="keyword">return</span> chain.proceed(originalRequest);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>上的代码总的功能就是往一个 list 里面一个一个的添加 interceptor ，interceptor 是一个抽象的接口，而代码里添加的各种各样的拦截器都是对 interceptor 接口不同的实现。例如，首先添加用户自己配置的interceptor，然后添加 retryAndFollowUpInterceptor 主要负责重定向和失败重连，接着添加 BridgeInterceptor 主要负责转化用户配置的url，header等配置生成一个服务器能接受的文本格式。列表中 CacheInterceptor 我们大概能猜出它的作用，这是一个缓存拦截器，根据 url 读取缓存中的数据，如果有结果就在这里砍断链式调用，成功返回结果。 ConnectInterceptor 则是开始向服务器发起连接。CallServerInterceptor 是正式与服务器发生关系，也是从这个拦截器中返回最终的 Response 结果。</p>
<p>当然，要发生上述的所有动作必须有一个起点，chain.proceed(originalRequest) 就是整个链路的入口，就在这里开始一个环节扣着一个环节执行下去。放回最终的结果，这不，一次完整的同步网络请求就完成了。</p>
<h5 id="异步请求"><a href="#异步请求" class="headerlink" title="异步请求"></a>异步请求</h5><p>上面是一个同步请求的解析，现在来谈谈异步请求，它跟同步请求有异曲同工之妙，大部分的流程实现还是沿用同一份代码，最大的不同是异步请求加入了 dispatcher ，见面知其意，就是由这个类来负责分发用户的请求。按照上面的思路，首先看看一个异步的示例</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//异步示例</span></div><div class="line">OkHttpClient client=<span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line">Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">                        .url(url)</div><div class="line">                        .build();</div><div class="line"></div><div class="line">client.newCall(request)</div><div class="line">        .enqueue(<span class="keyword">new</span> Callback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>Request 和 OkHttpClient 创建和同步请求一致，重点在与 RealCall() 接口里面的 enqueue(CallBack callback) 方法。传入的当然是一个 CallBack 接口对象用户需要服务器返回的消息通过这个对象传递回来。复写的 onResponse() 成功获取服务器端返回的结果，onFailure() 返回错误失败的信息，下面接着看 enqueued() 调用栈。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//RealCall.class</span></div><div class="line">  <span class="meta">@Override</span> </div><div class="line">  public void enqueue(<span class="type">Callback</span> responseCallback) &#123;</div><div class="line">    synchronized (<span class="keyword">this</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"Already Executed"</span>);</div><div class="line">      executed = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    client.dispatcher().enqueue(<span class="keyword">new</span> <span class="type">AsyncCall</span>(responseCallback));</div><div class="line">  &#125;</div><div class="line">    <span class="comment">//RealCall 内部类继承NamedRunnable（代码向下滑）</span></div><div class="line">  <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncCall</span> <span class="keyword">extends</span> <span class="title">NamedRunnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Callback</span> responseCallback;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="type">AsyncCall</span>(<span class="type">Callback</span> responseCallback) &#123;</div><div class="line">      <span class="keyword">super</span>(<span class="string">"OkHttp %s"</span>, redactedUrl().toString());</div><div class="line">      <span class="keyword">this</span>.responseCallback = responseCallback;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span> <span class="keyword">protected</span> void execute() &#123;</div><div class="line">      boolean signalledCallback = <span class="literal">false</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="type">Response</span> response = getResponseWithInterceptorChain();</div><div class="line">        <span class="keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) &#123;</div><div class="line">          signalledCallback = <span class="literal">true</span>;</div><div class="line">          responseCallback.onFailure(<span class="type">RealCall</span>.<span class="keyword">this</span>, <span class="keyword">new</span> <span class="type">IOException</span>(<span class="string">"Canceled"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          signalledCallback = <span class="literal">true</span>;</div><div class="line">          responseCallback.onResponse(<span class="type">RealCall</span>.<span class="keyword">this</span>, response);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123;</div><div class="line">        <span class="keyword">if</span> (signalledCallback) &#123;</div><div class="line">          <span class="comment">// Do not signal the callback twice!</span></div><div class="line">          <span class="type">Platform</span>.get().log(<span class="type">INFO</span>, <span class="string">"Callback failure for "</span> + toLoggableString(), e);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          responseCallback.onFailure(<span class="type">RealCall</span>.<span class="keyword">this</span>, e);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        client.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Dispatcher.class</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; readyAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; runningAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line">  </div><div class="line"> <span class="keyword">synchronized</span> <span class="keyword">void</span> enqueue(AsyncCall <span class="keyword">call</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (runningAsyncCalls.<span class="keyword">size</span>() &lt; maxRequests &amp;&amp; runningCallsForHost(<span class="keyword">call</span>) &lt; maxRequestsPerHost) &#123;</div><div class="line">      runningAsyncCalls.add(<span class="keyword">call</span>);</div><div class="line">      executorService().execute(<span class="keyword">call</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      readyAsyncCalls.add(<span class="keyword">call</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//NamedRunnable.class</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> String name;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">NamedRunnable</span><span class="params">(String format, Object... args)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.name = Util.format(format, args);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    String oldName = Thread.currentThread().getName();</div><div class="line">    Thread.currentThread().setName(name);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      execute();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      Thread.currentThread().setName(oldName);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RealCall 类 enqueue(Callback responseCallback) 中可以看到 dispatcher() 方法 ，dispatcher 也有一个 enqueue(AsyncCall call) 方法， 在这个 enqueue 方法里有一个列表并且执行 AsynCall ，如何执行 AsynCall 呢? AsynCall 是 RealCall 的内部类，集成 NamedRunnable，NamedRunnable 继承 Runanble。最终的与服务器发生交互的动作就在 AsynCall 的 execute() 方法内，这里就看到了熟悉的一行代码 ：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">Response response</span> = getResponseWithInterceptorChain();</div></pre></td></tr></table></figure>
<p>执行的流程就和同步的请求一模一样，不同点是再取得的服务器最终结果 Callback 接口放回给用户。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>更好读懂 OKHttp 的源码关键是要了解常用的设计模式，用构造模式创建出 OkHttpClient 和 Request 对象，使用责任链模式完成一个链式的调用。个人认为这就是 OkHttp 最基本的框架。代码的还有许多设计精良的部分，还未还好细读，目前还不把每一部分做到庖丁解牛的境界，有时间再一另帮 Blog 做另外的分析。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/21/java-list/" itemprop="url">
                  List简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2016-11-21T14:05:00+08:00" content="2016-11-21">
              2016-11-21
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="List简介"><a href="#List简介" class="headerlink" title="List简介"></a>List简介</h1><h3 id="List-四种实现类"><a href="#List-四种实现类" class="headerlink" title="List 四种实现类"></a>List 四种实现类</h3><ol>
<li>ArrayList</li>
<li>LinkeList</li>
<li>Vector</li>
<li>Stack</li>
</ol>
<h3 id="四种List的数据结构"><a href="#四种List的数据结构" class="headerlink" title="四种List的数据结构"></a>四种List的数据结构</h3><ol>
<li><p>ArrayList<br>动态数组，初始化分配一定长度的数组</p>
</li>
<li><p>LinkeList<br>双向链表</p>
</li>
<li><p>Vector<br>与 ArrayList 一样使用动态数组作为存储结构</p>
</li>
<li><p>Stack<br>Stack 继承 Vector ，不同的点是 Stack 是栈而不是队列，实现先进后出</p>
</li>
</ol>
<h3 id="四种List的不同使用场景的效率"><a href="#四种List的不同使用场景的效率" class="headerlink" title="四种List的不同使用场景的效率"></a>四种List的不同使用场景的效率</h3><p>四种 List 实现其实根据数据结构可以分为两类，ArrayList，Vector，Stack 都是动态数组划分为一类，后面一ArrayList作为代表作比较分析。另一类就用是双向链表(包含当前的值和前节点和后节点e)实现 LinkedList。</p>
<p>根据链表和数组的比较，链表在插入，删除操作效率更高，但是随机读取效率相比数组就比较低。<br>相反的，插入或删除一个数据就需要更长的时间，因为被修改位置后续的坐标全都要后移一位，所以耗时较长。</p>
<p>源码中可以看出，LinkedList 寻找的 index 大于List 长度的一半时，则会从后面开始读取数据<br>而数组的 List 直接根据下标返回所需的元素</p>
<h3 id="ArrayList-与-Vector-关于现场安全的比较"><a href="#ArrayList-与-Vector-关于现场安全的比较" class="headerlink" title="ArrayList 与 Vector 关于现场安全的比较"></a>ArrayList 与 Vector 关于现场安全的比较</h3><p>ArrayList 非现成安全，Vector 线程安全，所以在对单线程中使用 ArrayList 的效率要高于<br>Vector</p>
<h3 id="ArrayList-的遍历速度比较"><a href="#ArrayList-的遍历速度比较" class="headerlink" title="ArrayList 的遍历速度比较"></a>ArrayList 的遍历速度比较</h3><p>随机范围的效率最高<br>随机访问 &gt; for循环 &gt; 遍历器</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Wooi" />
          <p class="site-author-name" itemprop="name">Wooi</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wooi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/wooiiiwooiii" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/zzzidane/" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.instagram.com/wooiiiwooiii/" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>
                  
                  Instagram
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wooi</span>
</div>



        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
